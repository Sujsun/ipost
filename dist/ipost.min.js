/**
 * Plugin: ipost
 * Author: Sundarasan Natarajan
 * GIT: https://github.com/Sujsun/ipost.git
 * Version: 0.0.1
 */

!function e(t,i,o){function r(s,p){if(!i[s]){if(!t[s]){var a="function"==typeof require&&require;if(!p&&a)return a(s,!0);if(n)return n(s,!0);throw new Error("Cannot find module '"+s+"'")}var u=i[s]={exports:{}};t[s][0].call(u.exports,function(e){var i=t[s][1][e];return r(i||e)},u,u.exports,e,t,i,o)}return i[s].exports}for(var n="function"==typeof require&&require,s=0;s<o.length;s++)r(o[s]);return r}({1:[function(e,t,i){function o(e,t){if(!window.parent&&"string"!=typeof e)throw new Error("targetOrigin is missing");this.targetOrigin=e,this.config||(this.config={}),this.config=p(s,t),"string"==typeof this.config.mode||(this.config.mode="iframe"),this._requestPromises||(this._requestPromises={}),this._readyDeferred=$.Deferred(),this.event=new r}var r=e("minivents"),n={name:"ipost",description:"Eases the way of posting and recieving iframe messages",accessVariable:"ipost",version:"0.0.1"},s={iframeTimeout:1e4};o.prototype.inject=function(){return this._IFrame.apply(this,arguments)},o.prototype.open=function(){return this._openPopup.apply(this,arguments)},o.prototype.close=function(){return this._closePopup.apply(this,arguments)},o.prototype.listen=function(){return this._listen.apply(this,arguments)},o.prototype.post=function(e){return this._post.apply(this,arguments)},o.prototype.ready=function(){return this._postReady()},o.prototype.readyDeferred=function(){return this._readyDeferred},o.prototype.on=function(e,t){this.event.on(e,t)},o.prototype._IFrame=function(){return this._iframeReadyDeferred||(this._iframeReadyDeferred=$.when(this._injectIFrame.apply(this,arguments),this._readyDeferred).then(function(e){var t=$.Deferred();return t.resolve.apply(t,e)})),this._iframeReadyDeferred},o.prototype._PopupWindow=function(){return $.when(this._openPopup.apply(this,arguments),this._readyDeferred).then(function(e){var t=$.Deferred();return t.resolve.apply(t,e)})},o.prototype._injectIFrame=function(e,t){var i=$.Deferred(),o=e&&$(e)||$("<iframe/>");return t||(t={}),t.src&&(this.targetOrigin=t.src),o.attr("src",this.targetOrigin),this._isIFrameInjected=!0,o.on("load",function(){window.clearTimeout(this._iframeLoadTimeoutIndex),i.resolve(o.get(0),o)}),$("body").append(o),this._iframeLoadTimeoutIndex=window.setTimeout(function(){var e=new Error;e.type="iframe_load_timeout",e.message="IFrame timed out to load",i.reject(e)},this.config.iframeTimeout),i},o.prototype._openPopup=function(){var e,t=this,i=$.Deferred();return this._isPopupWindowOpen||(e=[this.targetOrigin],"string"==typeof this.config.target&&e.push(this.config.target),"string"==typeof this.config.windowOptions&&e.push(this.config.windowOptions),this._popupWindow=window.open.apply(window,e),this._isPopupWindowOpen=!0,this._popupWindowIntervalIndex=window.setInterval(function(){t._popupWindow.closed&&t._closePopup()},500)),i.resolve(this._popupWindow,$(this._popupWindow)),i.promise()},o.prototype._closePopup=function(){this._popupWindow&&(window.clearInterval(this._popupWindowIntervalIndex),this._popupWindow.close(),delete this._popupWindow,this._isPopupWindowOpen=!1)},o.prototype._postReady=function(){var e={};e.plugin=n.name,e.type="ready",e.mode=this.config.mode,this._postRaw(e)},o.prototype._post=function(){var e={};return e.id=a.s4(),e.type="ping",e.payload=Array.prototype.slice.call(arguments),e.plugin=n.name,this._requestPromises[e.id]=new $.Deferred,this._postRaw(e),this._requestPromises[e.id]},o.prototype._postRaw=function(e){var t=this;return this.config.child&&window.parent?(window.parent.postMessage(JSON.stringify(e),t.targetOrigin||"*"),$.Deferred().resolve().promise()):"popup"===this.config.mode&&(this.config.popup||this.config.child)&&window.opener?(window.opener.postMessage(JSON.stringify(e),t.targetOrigin||"*"),$.Deferred().resolve().promise()):"popup"===this.config.mode?this._PopupWindow().then(function(i,o){var r=$.Deferred();try{i.postMessage(JSON.stringify(e),t.targetOrigin),r.resolve()}catch(e){r.reject(e)}return r.promise()}):this._IFrame().then(function(i,o){var r=$.Deferred();try{i.contentWindow.postMessage(JSON.stringify(e),t.targetOrigin),r.resolve()}catch(e){r.reject(e)}return r.promise()})},o.prototype._listen=function(e){var t=this;t._isListening||$(window).on("message",function(e){t._messageHandler(e.originalEvent.data)})},o.prototype._postReply=function(e,t){var i=e.state(),o=e._ipostMessage;o.payload=Array.prototype.slice.call(t),"resolved"===i||"rejected"===i?(o.type="pong",o.state=i):o.type="notify",this._postRaw(o)},o.prototype._messageHandler=function(e){var t=this;try{e=JSON.parse(e)}catch(t){return void console.warn("Couldnot parse the received message. Message:",e)}if(e.plugin===n.name)if("ready"===e.type&&this.config.mode===e.mode)this._readyDeferred.resolve(),this.event.emit("ready");else if("ping"===e.type){(i=$.Deferred())._ipostMessage=e;var i=i.always(function(){t._postReply(i,arguments)}).progress(function(){t._postReply(i,arguments)}),o=[];o.push("message"),o.push(i),o=o.concat(e.payload),this.event.emit.apply(this.event,o)}else{var r=this._requestPromises[e.id];if(r)switch(e.type){case"pong":"resolved"===e.state?r.resolve.apply(r,e.payload):r.reject.apply(r,e.payload),this._removeRequestPromise(e.id);break;case"notify":r.notify.apply(r,e.payload);break;default:console.warn("Unknown message type. messageType:",e.type)}}},o.prototype._removeRequestPromise=function(e){delete this._requestPromises[e]};var p=function(e,t){var i,o={};for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=e[i]);for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&(o[i]=t[i]);return o},a={s4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()}};window.IPost=o,t.exports=o},{minivents:2}],2:[function(e,t,i){t.exports=function(e){var t={},i=[];(e=e||this).on=function(e,i,o){(t[e]=t[e]||[]).push([i,o])},e.off=function(e,o){e||(t={});for(var r=t[e]||i,n=r.length=o?r.length:0;n--;)o==r[n][0]&&r.splice(n,1)},e.emit=function(e){for(var o,r=t[e]||i,n=r.length>0?r.slice(0,r.length):r,s=0;o=n[s++];)o[0].apply(o[1],i.slice.call(arguments,1))}}},{}]},{},[1]);